<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>Markdown Preview</title>

  <script type="importmap">
    {
      "imports": {
        "lit": "https://esm.sh/lit@3.1.0",
        "lit/": "https://esm.sh/lit@3.1.0/",
        "codemirror": "https://esm.sh/*codemirror@6.0.1",
        "@codemirror/": "https://esm.sh/*@codemirror/",
        "@lezer/": "https://esm.sh/*@lezer/",
        "style-mod": "https://esm.sh/style-mod",
        "w3c-keyname": "https://esm.sh/w3c-keyname",
        "crelt": "https://esm.sh/crelt",
        "@marijn/find-cluster-break": "https://esm.sh/@marijn/find-cluster-break",
        "marked": "https://esm.sh/marked@16.0.0",
        "vega": "https://esm.sh/vega@5.22.1",
        "vega-lite": "https://esm.sh/vega-lite@5.6.0",
        "vega-embed": "https://esm.sh/vega-embed@6.21.0"
      }
    }
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      height: 100vh;
      overflow: hidden;
    }

    #root {
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="module">
    import { LitElement, html, css } from "lit";
    import { basicSetup, EditorView } from "codemirror";
    import { EditorState } from "@codemirror/state";
    import { markdown } from "@codemirror/lang-markdown";
    import { marked } from "marked";
    import vegaEmbed from "vega-embed";

    class VegaLiteChart extends LitElement {
      static properties = {
        spec: { type: String }
      };

      static styles = css`
        :host { display: block; margin: 20px 0; }
        #chart { width: 100%; }
        .empty { color: #999; padding: 12px; }
        .error { color: #c33; padding: 8px; }
      `;

      constructor() {
        super();
        this.spec = null;
      }

      updated(changedProperties) {
        if (changedProperties.has("spec")) {
          this.renderChart();
        }
      }

      async renderChart() {
        const chartDiv = this.renderRoot.querySelector("#chart");
        if (!chartDiv) return;

        if (!this.spec) {
          chartDiv.innerHTML = '<div class="empty">No chart spec provided</div>';
          return;
        }

        let specObj;
        try {
          specObj = JSON.parse(this.spec);
        } catch (e) {
          chartDiv.innerHTML = '<div class="error">Invalid spec JSON</div>';
          return;
        }

        try {
          await vegaEmbed(chartDiv, specObj, { actions: false });
        } catch (e) {
          console.error("vegaEmbed error:", e);
          chartDiv.innerHTML = '<div class="error">Chart render error</div>';
        }
      }

      render() {
        return html`<div id="chart"></div>`;
      }
    }

    class DataTable extends LitElement {
      static properties = {
        data: { type: String },
        columnConfig: { type: String }
      };

      static styles = css`
        :host { display: block; margin: 20px 0; }
        table {
          width: 100%;
          border-collapse: collapse;
        }
        th, td {
          padding: 8px;
          text-align: left;
          border: 1px solid #ddd;
        }
        th {
          background: #f5f5f5;
          font-weight: 600;
        }
      `;

      constructor() {
        super();
        this.data = '[]';
        this.columnConfig = '[]';
      }

      render() {
        let dataArray = [];
        let configArray = [];

        try {
          dataArray = JSON.parse(this.data);
          configArray = JSON.parse(this.columnConfig);
        } catch (e) {
          return html`<div>Error parsing data</div>`;
        }

        return html`
          <table>
            <thead>
              <tr>
                ${configArray.map(col => {
          const key = Object.keys(col)[0];
          return html`<th>${col[key]}</th>`;
        })}
              </tr>
            </thead>
            <tbody>
              ${dataArray.map(row => html`
                <tr>
                  ${configArray.map(col => {
          const key = Object.keys(col)[0];
          return html`<td>${row[key]}</td>`;
        })}
                </tr>
              `)}
            </tbody>
          </table>
        `;
      }
    }

    class MarkdownEditor extends LitElement {
      static properties = { value: { type: String } };
      static styles = css`
        :host { display: block; height: 100%; overflow: hidden; }
        #editor { height: 100%; overflow: auto; }
        .cm-editor { height: 100%; }
        .cm-scroller { overflow: auto; }
      `;

      constructor() {
        super();
        this.value = "";
        this.editorView = null;
      }

      firstUpdated() {
        const editorContainer = this.shadowRoot.getElementById("editor");
        const startState = EditorState.create({
          doc: this.value,
          extensions: [
            basicSetup,
            markdown(),
            EditorView.updateListener.of((update) => {
              if (update.docChanged) {
                this.value = update.state.doc.toString();
                this.dispatchEvent(
                  new CustomEvent("change", { detail: { value: this.value } })
                );
              }
            }),
          ],
        });

        this.editorView = new EditorView({
          state: startState,
          parent: editorContainer,
        });
      }

      render() {
        return html`<div id="editor"></div>`;
      }
    }

    class MarkdownPreview extends LitElement {
      static properties = { markdown: { type: String } };
      static styles = css`
        :host {
          display: block;
          height: 100%;
          overflow: auto;
          padding: 20px;
          background: #fafafa;
        }
        .preview {
          max-width: 800px;
          margin: 0 auto;
          background: white;
          padding: 30px;
          border-radius: 4px;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
      `;

      constructor() {
        super();
        this.markdown = "";
      }

      render() {
        const htmlContent = marked.parse(this.markdown);
        return html`
          <div class="preview">
            ${htmlContent
            ? html`<div .innerHTML=${htmlContent}></div>`
            : html`<p style="color: #999;">Start typing markdown...</p>`}
          </div>
        `;
      }
    }

    class AppRoot extends LitElement {
      static properties = { markdownText: { type: String } };
      static styles = css`
        :host { display: block; height: 100%; }
        .container {
          display: grid;
          grid-template-columns: 1fr 1fr;
          height: 100%;
          gap: 1px;
          background: #ddd;
        }
        .panel {
          background: white;
          overflow: hidden;
          display: flex;
          flex-direction: column;
        }
        .panel-header {
          padding: 12px 20px;
          background: #f5f5f5;
          border-bottom: 1px solid #ddd;
          font-weight: 600;
        }
        .panel-content {
          flex: 1;
          overflow: hidden;
        }
      `;

      constructor() {
        super();
        this.markdownText = `# Welcome to Markdown Preview\n\n## Features\n- Live preview\n- **Bold** and *italic* text\n- Code snippets\n\n\`\`\`javascript\nconst hello = "world";\nconsole.log(hello);\n\`\`\`\n\n> This is a blockquote\n\n### Lists\n1. First item\n2. Second item\n3. Third item\n\n<data-table\n data='[{"city":"Rio","pop":6748000},{"city":"SP","pop":12252000}]'\n columnConfig='[{"city":"City"},{"pop":"Population"}]'>\n</data-table>\n\n<vegalite-chart\nspec='{"mark":"bar","encoding":{"x":{"field":"city","type":"nominal"},"y":{"field":"pop","type":"quantitative"}},"data":{"values":[{"city":"Rio","pop":6748000},{"city":"SP","pop":12252000},{"city":"BH","pop":2521564}]},"width":400,"height":200}'>\n</vegalite-chart>`;
      }

      handleEditorChange(e) {
        this.markdownText = e.detail.value;
      }

      render() {
        return html`
          <div class="container">
            <div class="panel">
              <div class="panel-header">Markdown Editor</div>
              <div class="panel-content">
                <markdown-editor .value=${this.markdownText} @change=${this.handleEditorChange}></markdown-editor>
              </div>
            </div>
            <div class="panel">
              <div class="panel-header">Preview</div>
              <div class="panel-content">
                <markdown-preview .markdown=${this.markdownText}></markdown-preview>
              </div>
            </div>
          </div>
        `;
      }
    }

    customElements.define("markdown-editor", MarkdownEditor);
    customElements.define("markdown-preview", MarkdownPreview);
    customElements.define("data-table", DataTable);
    customElements.define("vegalite-chart", VegaLiteChart);
    customElements.define("app-root", AppRoot);

    document.getElementById("root").appendChild(document.createElement("app-root"));
  </script>
</body>

</html>